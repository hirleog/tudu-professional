name: Deploy Tudu Professional (Main Branch)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      # ConfiguraÃ§Ã£o SSH robusta
      - name: Configurar acesso ao servidor
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.TUDU_PROFESSIONAL_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          cat <<EOF > ~/.ssh/config
          Host tudu-prod
            HostName 89.116.73.70
            User deployer
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking yes
            LogLevel VERBOSE
          EOF

          ssh-keyscan -t ed25519 89.116.73.70 >> ~/.ssh/known_hosts

      # Ambiente Node.js
      - name: Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # InstalaÃ§Ã£o limpa de dependÃªncias
      - name: Instalar dependÃªncias
        run: |
          npm ci --no-audit --prefer-offline
          if [ $? -ne 0 ]; then
            echo "âš ï¸ Fallback para npm install"
            npm install --force
          fi
          npm cache clean --force

      # Build com verificaÃ§Ã£o
      - name: Build do projeto
        run: |
          npm run build -- --configuration=production
          echo "âœ” Build completo. ConteÃºdo:"
          ls -lh dist/tudu-professional/
          echo "build_version=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV

      # Deploy em 3 etapas
      - name: 1. Preparar servidor (limpeza)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 89.116.73.70
          username: deployer
          key: ${{ secrets.TUDU_PROFESSIONAL_SSH_KEY }}
          script: |
            echo "ğŸ”„ Limpando diretÃ³rio (exceto .env)"
            cd /var/www/mfe-tudu-professional/
            shopt -s extglob
            rm -rf !(.env|.env.production|uploads)
            echo "ğŸ“‚ ConteÃºdo atual:"
            ls -lah

      - name: 2. Sincronizar arquivos (rsync)
        run: |
          rsync -avz \
            --progress \
            --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            dist/tudu-professional/ \
            deployer@89.116.73.70:/var/www/mfe-tudu-professional/

      - name: 3. Finalizar deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 89.116.73.70
          username: deployer
          key: ${{ secrets.TUDU_PROFESSIONAL_SSH_KEY }}
          script: |
            # PermissÃµes
            echo "ğŸ”’ Ajustando permissÃµes"
            sudo chown -R deployer:www-data /var/www/mfe-tudu-professional
            find /var/www/mfe-tudu-professional -type d -exec chmod 775 {} \;
            find /var/www/mfe-tudu-professional -type f -exec chmod 664 {} \;

            # ServiÃ§os
            echo "ğŸ”„ Reiniciando serviÃ§os"
            sudo systemctl reload nginx
            if pm2 list | grep -q "tudu-professional"; then
              pm2 restart tudu-professional --update-env
            fi

            # VerificaÃ§Ã£o final
            echo "âœ… DEPLOY COMPLETO"
            echo "ğŸ•’ VersÃ£o: ${{ env.build_version }}"
            echo "ğŸ“ Ãšltimos arquivos:"
            ls -lt /var/www/mfe-tudu-professional/ | head -5
            echo "ğŸŒ URL: https://professional.use-tudu.com.br"
